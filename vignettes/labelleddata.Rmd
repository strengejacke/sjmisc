---
title: "Working with Labelled Data"
author: "Daniel LÃ¼decke"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with Labelled Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Basically, this package covers two domains of functionality:

  * Reading and writing data between R and other statistical software packages like _SPSS_, _SAS_ or _Stata_ and working with labelled data; this includes easy ways to get and set label attributes, to convert labelled vectors into factors (and vice versa), or to deal with multiple declared missing values etc.
  * Data transformation tasks like recoding, dichotomizing or grouping variables, setting and replacing missing values. The data transformation functions also support labelled data.

# Labelled Data

In software like SPSS, it is common to have value and variable labels as variable attributes. Variable values, even if categorical, are mostly numeric. In R, however, you may use labels as values directly:

```{r}
factor(c("low", "high", "mid", "high", "low"))
```

Reading SPSS-data (from haven, foreign or sjmisc), keeps the numeric values for variables and adds the value and variable labels as attributes. See following example from the sample-dataset efc, which is part of the sjmisc-package:

```{r}
library(sjmisc)
data(efc)
str(efc$e42dep)
```

While all plotting and table functions of the [sjPlot-package](http://cran.r-project.org/web/packages/sjPlot/index.html) make use of these attributes, many packages and/or functions do not consider these attributes, e.g. R base graphics:

```{r warning=FALSE, fig.height=6, fig.width=7}
library(sjmisc)
data(efc)
barplot(
  table(efc$e42dep, efc$e16sex), 
  beside = T, 
  legend.text = T
)
```

As you can see in the above figure, the plot has neither axis nor legend labels.

# Adding value labels as factor values

`to_label()` is a sjmisc-function that converts a numeric variable into a factor and sets attribute-value-labels as factor levels. When using factors with valued levels, the bar plot will be labelled.

```{r warning=FALSE, fig.height=6, fig.width=7}
barplot(
  table(to_label(efc$e42dep),
        to_label(efc$e16sex)), 
  beside = T, 
  legend.text = T
)
```

# Getting and setting value and variable labels

There are four functions that let you easily set or get value and variable labels of either a single vector or a complete data frame:

  * `get_label()` to get variable labels
  * `get_labels()` to get value labels
  * `set_label()` to set variable labels (add them as vector attribute)
  * `set_labels()` to set value labels (add them as vector attribute)

With this function, you can easily add titles to plots dynamically, i.e. depending on the variable that is plotted.

```{r warning=FALSE, fig.height=6, fig.width=7}
barplot(
  table(to_label(efc$e42dep),
        to_label(efc$e16sex)), 
  beside = T, 
  legend.text = T,
  main = get_label(efc$e42dep)
)
```

## Another example

Converting `labelled`-class vectors into factors usually drops label attributes (e.g. using `as_factor()`) or replaces values with the associated labels (like `to_label()` does). If you want to convert a labelled vector into a numeric factor, but keep the label attributes (including variable labels), use `to_factor()`.

Functions like `lm()` simply copy the label-attributes and store these information in the returned object; see following example from the `sjPlot`-package:

```{r collapse=TRUE}
library(sjPlot)
data(efc)
# make education categorical
efc$c172code <- to_factor(efc$c172code)
fit <- lm(barthtot ~ c160age + c12hour + c172code + c161sex, data = efc)
```

```{r eval=FALSE, collapse=TRUE}
sjt.lm(fit, group.pred = TRUE)
```
`r sjt.lm(fit,group.pred = TRUE, no.output=TRUE)$knitr`

Looking at `str(fit$frame)` shows us that both variable and value label attributes are still there. Packages like **sjPlot** make use of this feature and automatically label the table output (like seen above).

# Restore labels from subsetted data

The base `subset()` function drops label attributes (or vector attributes in general) when subsetting data. In the sjmisc-package, there are handy functions to deal with this problem: `copy_labels()` and `remove_labels()`.

`copy_labels()` adds back labels to a subsetted data frame based on the original data frame. And `remove_labels()` removes all label attributes.


## Losing labels during subset

```{r}
efc.sub <- subset(efc, subset = e16sex == 1, select = c(4:8))
str(efc.sub)
```

## Add back labels

```{r, message=FALSE}
efc.sub <- copy_labels(efc.sub, efc)
str(efc.sub)
```

# Conclusion

When working with labelled data, especially when working with data sets imported from other software packages, it comes very handy to make use of the label attributes. The **sjmisc**-package supports this feature and offers useful functions for these tasks.
